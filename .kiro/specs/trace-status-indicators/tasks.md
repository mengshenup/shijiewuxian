# 实现计划

- [x] 1. 在 trace.py 中实现状态推断功能


  - 添加关键词常量定义（ERROR_KEYWORDS, WARNING_KEYWORDS, SUCCESS_KEYWORDS）
  - 实现 `infer_status(context)` 函数，根据关键词推断状态
  - 实现优先级规则：错误 > 警告 > 成功 > 默认info
  - _需求：4.1, 4.2, 4.3, 4.4, 4.8_

- [x] 1.1 编写 infer_status 的属性测试


  - **属性 1：状态推断一致性**
  - **属性 2：错误关键词优先级**
  - **属性 4：默认状态推断**
  - **属性 9：中文关键词支持**
  - **验证：需求 4.1, 4.2, 4.3, 4.4, 4.6, 4.8**

- [x] 2. 增强 trace.py 的 log_auto 函数


  - 添加可选的 `status` 参数到 `log_auto(context="", status=None)`
  - 如果 status 为 None，调用 `infer_status(context)` 自动推断
  - 如果 status 不为 None，验证其有效性（在有效值列表中）
  - 如果 status 无效，默认使用 "info" 并记录警告
  - 修改TRACE标记输出格式，添加status字段：`[TRACE:module:line:timestamp:status] context`
  - _需求：2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 2.1 编写 log_auto 的属性测试


  - **属性 3：显式状态优先**
  - **属性 8：状态持久化**
  - **属性 10：无效状态处理**
  - **验证：需求 2.1, 2.3, 2.5, 2.6, 4.5**

- [x] 3. 增强 trace_parser.py 的解析功能


  - 修改 `parse_trace_line(line)` 函数以支持新的TRACE格式（含status字段）
  - 实现向后兼容：如果TRACE标记不含status，从context推断
  - 确保解析后的dict包含 'status' 字段
  - 处理解析错误，跳过无效行并记录警告
  - _需求：5.1, 5.2, 5.5_

- [x] 3.1 编写 trace_parser 的单元测试


  - 测试新格式解析（含status）
  - 测试旧格式解析（不含status，应自动推断）
  - 测试无效格式处理
  - _需求：5.1, 5.2, 5.5_

- [x] 3.2 编写向后兼容性的属性测试


  - **属性 7：向后兼容性**
  - **验证：需求 5.2, 5.5**

- [x] 4. 在 result_analyzer.py 中实现状态图标映射


  - 添加 `STATUS_ICONS` 常量字典
  - 实现 `get_status_icon(status)` 函数
  - 处理无效status（返回默认图标或空字符串）
  - _需求：1.2, 1.3, 1.4, 1.5_

- [x] 4.1 编写 get_status_icon 的单元测试


  - 测试所有有效status值的图标映射
  - 测试无效status的处理
  - _需求：1.2, 1.3, 1.4, 1.5_

- [x] 4.2 编写状态图标映射的属性测试

  - **属性 5：状态图标映射完整性**
  - **验证：需求 1.2, 1.3, 1.4, 1.5**

- [x] 5. 增强 result_analyzer.py 的表格显示功能


  - 修改 `print_trace_history(trace_info)` 函数
  - 在表头添加"状态"列（位于"说明"和"耗时"之间）
  - 为每个trace条目显示状态图标
  - 如果条目缺少status字段，从context推断（向后兼容）
  - 确保状态列宽度固定为6个字符
  - 保持表格对齐和格式一致性
  - _需求：1.1, 3.1, 3.2, 3.3, 3.4, 3.5, 5.4_

- [x] 5.1 编写表格显示的单元测试


  - 测试包含状态列的表格输出
  - 测试表头包含"状态"标签
  - 测试状态列宽度为6字符
  - _需求：3.1, 3.4, 3.5_

- [x] 5.2 编写表格格式的属性测试

  - **属性 6：表格格式一致性**
  - **验证：需求 3.3**

- [x] 6. 检查点 - 确保所有测试通过


  - 确保所有测试通过，如有问题请询问用户

- [x] 7. 更新现有代码以使用新功能（可选）

  - 在关键的成功/失败分支中添加显式status参数
  - 例如：`log_auto("资源加载成功", status="success")`
  - 例如：`log_auto("错误：资源加载失败", status="error")`
  - 注意：这是可选的，因为自动推断已经能正常工作
  - _需求：2.1_

- [x] 8. 创建使用示例和文档


  - 在 `.kiro/specs/trace-status-indicators/` 创建 `USAGE.md`
  - 包含使用示例：显式指定status vs 自动推断
  - 包含关键词列表和优先级规则
  - 包含表格输出示例
  - _需求：所有_

- [x] 9. 最终检查点 - 端到端测试



  - 运行完整的地图生成流程
  - 验证执行历史表格包含状态列
  - 验证状态图标正确显示
  - 验证向后兼容性（旧trace数据正常显示）
  - 确保所有测试通过，如有问题请询问用户
