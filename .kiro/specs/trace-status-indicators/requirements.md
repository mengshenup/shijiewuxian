# 需求文档

## 简介

本功能为地图生成追踪系统的模块执行历史表格添加可视化状态标志。当前执行历史显示模块名、行号、说明和时间信息。此增强功能将在说明列后添加状态图标（✅ 成功、⚠️ 警告、❌ 错误、ℹ️ 信息），以便快速直观地了解每个步骤的执行状态。

## 术语表

- **追踪系统（Trace System）**: 在 UE5 地图生成过程中记录模块执行历史的追踪系统
- **状态标志（Status Indicator）**: 表示追踪条目执行状态的可视化图标（表情符号），包括：
  - ✅ 成功（success）：操作成功完成
  - ⚠️ 警告（warning）：操作完成但有警告
  - ❌ 错误（error）：操作失败或出错
  - ℹ️ 信息（info）：一般信息性日志，无特定状态
- **模块历史（Module History）**: 地图生成过程中所有追踪执行点的时间顺序列表
- **上下文（Context）**: 调用 `log_auto()` 时提供的描述文本
- **结果分析器（Result Analyzer）**: 显示格式化执行历史表格的组件

## 状态判断机制说明

系统通过以下两种方式确定状态标志：

### 方式1：显式指定（优先级最高）
开发者在调用 `log_auto()` 时直接指定 status 参数：
```python
log_auto("资源加载成功", status="success")  # 显式指定为成功
log_auto("资源加载失败", status="error")    # 显式指定为错误
```

### 方式2：自动推断（默认方式）
当未提供 status 参数时，系统会分析 context 文字中的关键词：
```python
log_auto("资源加载成功")  # 包含"成功" → 自动推断为 ✅
log_auto("资源加载失败")  # 包含"失败" → 自动推断为 ❌
log_auto("开始构建训练室")  # 无特殊关键词 → 默认为 ℹ️
```

**关键词列表（基于实际代码分析）：**
- **成功关键词**：成功、完成、创建、生成、保存、验证成功、放置成功、配置、初始化
- **错误关键词**：错误、失败、异常
- **警告关键词**：警告、跳过、未找到

**优先级规则：**
1. 显式 status 参数 > 关键词推断
2. 错误关键词 > 成功关键词（避免"加载失败"被误判为成功）

## 需求

### 需求 1

**用户故事：** 作为开发者，我希望在执行历史中看到状态标志，以便快速识别成功操作、警告和错误，而无需阅读详细日志。

#### 验收标准

1. WHEN 显示执行历史时 THEN 系统 SHALL 在说明列后包含状态标志列
2. WHEN 追踪条目表示成功操作时 THEN 系统 SHALL 显示 ✅ 成功标志
3. WHEN 追踪条目表示警告条件时 THEN 系统 SHALL 显示 ⚠️ 警告标志
4. WHEN 追踪条目表示错误条件时 THEN 系统 SHALL 显示 ❌ 错误标志
5. WHEN 追踪条目表示信息输出时 THEN 系统 SHALL 显示 ℹ️ 信息标志

### 需求 2

**用户故事：** 作为开发者，我希望在追踪调用中指定状态标志，以便传达每个操作的执行状态。

#### 验收标准

1. WHEN 使用 status 参数调用 `log_auto(context, status="success")` 时 THEN 系统 SHALL 将状态记录到追踪条目中
2. WHEN 未提供 status 参数时 THEN 系统 SHALL 根据 context 文字自动推断状态（见需求4）
3. WHEN 提供无效的 status 值时 THEN 系统 SHALL 默认使用信息状态并记录警告
4. THE 系统 SHALL 支持以下状态值："success"、"warning"、"error"、"info"
5. THE 系统 SHALL 将状态值存储在模块历史数据结构中
6. THE 显式指定的 status 参数 SHALL 优先于自动推断的状态

### 需求 3

**用户故事：** 作为开发者，我希望状态标志以良好格式的表格显示，以便执行历史保持可读性和组织性。

#### 验收标准

1. WHEN 显示执行历史表格时 THEN 系统 SHALL 在"说明"和"耗时"列之间包含"状态"列
2. WHEN 格式化表格时 THEN 系统 SHALL 保持适当的列对齐
3. WHEN 表格包含许多条目时 THEN 系统 SHALL 在整个表格中保持一致的格式
4. THE 状态列 SHALL 具有 6 个字符的固定宽度以容纳表情符号图标
5. THE 表格标题 SHALL 包含"状态"标签

### 需求 4

**用户故事：** 作为开发者，我希望从上下文关键词自动推断状态，以便现有的追踪调用（在 if/else 分支中）无需修改即可显示有意义的状态。

#### 验收标准

1. WHEN 追踪上下文包含成功关键词（成功、完成、创建、生成、保存、验证成功、放置成功、配置、初始化）时 THEN 系统 SHALL 推断为成功状态并显示 ✅
2. WHEN 追踪上下文包含警告关键词（警告、跳过、未找到）时 THEN 系统 SHALL 推断为警告状态并显示 ⚠️
3. WHEN 追踪上下文包含错误关键词（错误、失败、异常、加载失败）时 THEN 系统 SHALL 推断为错误状态并显示 ❌
4. WHEN 没有关键词匹配时 THEN 系统 SHALL 默认为信息状态并显示 ℹ️
5. WHEN 提供显式 status 参数时 THEN 系统 SHALL 使用显式状态并忽略关键词推断
6. THE 系统 SHALL 支持中文关键词匹配（如"成功"、"失败"、"错误"等）
7. THE 关键词匹配 SHALL 不区分大小写
8. THE 错误关键词 SHALL 优先于成功关键词（例如"加载失败"应识别为错误而非成功）

### 需求 5

**用户故事：** 作为开发者，我希望与现有追踪调用向后兼容，以便不需要立即更新所有现有代码。

#### 验收标准

1. WHEN 现有代码调用 `log_auto()` 而不带 status 参数时 THEN 系统 SHALL 使用推断状态正常运行
2. WHEN 显示没有状态的旧追踪数据历史时 THEN 系统 SHALL 从上下文推断状态
3. THE 系统 SHALL 在添加状态功能时不破坏现有功能
4. THE 系统 SHALL 为非状态列保持相同的输出格式
5. THE 系统 SHALL 优雅地处理缺失的状态数据
